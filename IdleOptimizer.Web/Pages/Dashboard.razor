@page "/"
@using IdleOptimizer.Models
@using IdleOptimizer.Services
@using MudBlazor
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject ICalculationService CalculationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILocalStorageService LocalStorageService
@inject IJSRuntime JSRuntime
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudCard>
        <MudCardContent>
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudText Typo="Typo.h4">Idle Game Optimizer</MudText>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        @if (hasUserId && !string.IsNullOrEmpty(currentUserId))
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.AccountCircle" 
                               OnClick="OpenUserIdDialog">
                                <span>User ID: @currentUserId.Substring(0, Math.Min(8, currentUserId.Length))...</span>
                            </MudButton>
                        }

                        <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.PersonAdd" 
                           OnClick="CreateNewUserProfile">
                            <span> New User Profile</span>
                        </MudButton>
                </MudStack>
            </MudStack>
            @if (CalculationService.Resources.Count > 0)
            {
                <MudTable Items="@CalculationService.Resources" Hover="true" Dense="true" Striped="true" Bordered="true" 
                          Elevation="1" Class="mt-2 mb-4">
                    <RowTemplate>
                        <MudTd DataLabel="Resource Name">
                            <strong>@context.Name</strong>
                        </MudTd>
                        <MudTd DataLabel="Total Production" Align="Align.Right">
                            @{
                                CalculationService.UpdateResourceTotalProduction();
                                var resourceProduction = CalculationService.GetTotalProductionByResourceName(context.Name);
                            }
                            <MudText Typo="Typo.body1">@FormatNumber(resourceProduction, 2)</MudText>
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" 
                                     StartIcon="@Icons.Material.Filled.Delete" 
                                     OnClick="async () => await DeleteResource(context)">
                                Delete
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudText Typo="Typo.body2" Class="mt-2">No resources defined. Add a resource to get started.</MudText>
            }

            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
                       OnClick="OpenAddGeneratorDialog" Class="mb-2 mr-2">
                Add Generator
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" 
                       OnClick="OpenAddResearchDialog" Class="mb-2 mr-2">
                Add Research
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Add" 
                       OnClick="OpenAddResourceDialog" Class="mb-2">
                Add Resource
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Refresh" 
                       OnClick="RefreshRankings" Class="mb-2 ml-2">
                Refresh Rankings
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteSweep" 
                       OnClick="OpenDeleteAllDialog" Class="mb-2 ml-2">
                Delete All
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.Download" 
                       OnClick="DownloadSaveFiles" Class="mb-2 ml-2">
                Download Save Files
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Upload" 
                       OnClick="TriggerFileInput" Class="mb-2 ml-2">
                Import Save Files
            </MudButton>
            <InputFile OnChange="HandleFileUpload" multiple accept=".csv" style="display: none;" @ref="fileInputElement" id="csvFileInput" />

            <MudTable Items="@rankedUpgrades" Hover="true" Dense="true" Striped="true" Bordered="true" 
                      Elevation="2" Class="mt-4">
                <HeaderContent>
                    <MudTh>Item Name</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh Align="Align.Right">Contribute</MudTh>
                    <MudTh Align="Align.Right">Cost</MudTh>
                    <MudTh Align="Align.Right">Gain</MudTh>
                    <MudTh Align="Align.Right">Cascade Score</MudTh>
                    <MudTh Align="Align.Center">Timer</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @{
                        var isEditing = IsEditing(context);
                        var editItem = isEditing ? GetOrCreateEditItem(context) : context;
                    }
                    <MudTd DataLabel="Item Name">
                        @if (isEditing)
                        {
                            <MudTextField @bind-Value="@editItem.ItemName" Variant="Variant.Outlined" Dense="true" />
                        }
                        else
                        {
                            @context.ItemName
                        }
                    </MudTd>
                    <MudTd DataLabel="Type">
                        @if (isEditing)
                        {
                            <MudSelect T="string" @bind-Value="@editItem.Type" Variant="Variant.Outlined" Dense="true">
                                <MudSelectItem Value="@("Generator")">Generator</MudSelectItem>
                                <MudSelectItem Value="@("Research")">Research</MudSelectItem>
                            </MudSelect>
                        }
                        else
                        {
                            <MudChip Size="Size.Small" Color="@(context.Type == "Generator" ? Color.Primary : Color.Secondary)">
                                @context.Type
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Contribute" Align="Align.Right">
                        @if (context.Type == "Generator" && context.SourceItem is Generator generator)
                        {
                            @if (isEditing)
                            {
                                <MudStack Spacing="2">
                                    @{
                                        var editResources = GetOrCreateEditResources(generator);
                                    }
                                    @foreach (var resource in editResources)
                                    {
                                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                            <MudSelect T="string" @bind-Value="@resource.ResourceName" Label="Resource" 
                                                       Variant="Variant.Outlined" Style="flex: 1;">
                                                                <MudSelectItem Value="@((string?)null)">Select Resource</MudSelectItem>
                                                                @foreach (var res in CalculationService.Resources)
                                                                {
                                                                    <MudSelectItem Value="@res.Name">@res.Name</MudSelectItem>
                                                                }
                                                            </MudSelect>
                                                            <MudNumericField @bind-Value="@resource.Value" Label="Production" 
                                                                           Variant="Variant.Outlined" Min="0.01" Style="flex: 1;" />
                                                            <MudSelect T="string" @bind-Value="@resource.Abbr" Label="Abbr" 
                                                                     Variant="Variant.Outlined" Style="width: 100px;" Dense="true">
                                                                <MudSelectItem Value="@((string?)null)">None</MudSelectItem>
                                                                <MudSelectItem Value="@("K")">K</MudSelectItem>
                                                                <MudSelectItem Value="@("M")">M</MudSelectItem>
                                                                <MudSelectItem Value="@("B")">B</MudSelectItem>
                                                                <MudSelectItem Value="@("T")">T</MudSelectItem>
                                                                <MudSelectItem Value="@("Qa")">Qa</MudSelectItem>
                                                                <MudSelectItem Value="@("Qi")">Qi</MudSelectItem>
                                                                <MudSelectItem Value="@("Sx")">Sx</MudSelectItem>
                                                                <MudSelectItem Value="@("Sp")">Sp</MudSelectItem>
                                                                <MudSelectItem Value="@("Oc")">Oc</MudSelectItem>
                                                                <MudSelectItem Value="@("No")">No</MudSelectItem>
                                                            </MudSelect>
                                                            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Error" 
                                                                     OnClick="() => RemoveEditResource(generator, resource)">
                                                                Remove
                                                            </MudButton>
                                                        </MudStack>
                                            }
                                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                                     StartIcon="@Icons.Material.Filled.Add" OnClick="() => AddEditResource(generator)" Class="mb-2">
                                                Add Resource
                                            </MudButton>
                                    <MudNumericField @bind-Value="@editItem.Count"
                                                     Label="Count"
                                                     Variant="Variant.Outlined"
                                                     Dense="true"
                                                     Style="flex: 1;" />
                                </MudStack>
                            }
                            else
                            {
                                var contribution = GetGeneratorContribution(generator);
                                var resources = generator.GetCurrentProductionByResource();
                                
                                <MudStack Spacing="1">
                                    @if (resources.Count > 1)
                                    {
                                        @foreach (var resource in resources)
                                        {
                                            var resourceTotalProd = CalculationService.GetTotalProductionByResourceName(resource.Key);
                                            var percentage = resourceTotalProd > 0 ? (resource.Value / resourceTotalProd) * 100 : 0;
                                            <div>
                                                <strong>@resource.Key:</strong> @FormatNumber(resource.Value, 2)
                                            </div>
                                            <div class="text-caption" style="color: #90caf9;">
                                                Total: @FormatNumber(resourceTotalProd, 2) (@percentage.ToString("F1")%)
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        var totalProduction = CalculationService.GetTotalProductionByResourceName(resources.Keys.First());
                                        var percentage = totalProduction > 0 ? (contribution / totalProduction) * 100 : 0;
                                        <MudStack Row="true" Spacing="2">
                                            <strong>@FormatNumber(generator.BaseProduction, 2) x @generator.Count = @FormatNumber(contribution, 2)</strong>
                                            <div class="text-caption" style="color: #90caf9;">
                                                (@percentage.ToString("F1")%)
                                            </div>
                                        </MudStack>
                                    }
                                </MudStack>
                            }
                        }
                        else if (context.Type == "Research" && context.SourceItem is Research research)
                        {
                            @if (research.TargetGenerators != null && research.TargetGenerators.Count > 0)
                            {
                                @foreach (var target in research.TargetGenerators)
                                {
                                    <div class="mb-1">
                                        @target <span style="color: #4caf50; font-weight: bold;">(x@((research.MultiplierValue ).ToString()))</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <span>-</span>
                            }
                        }
                    </MudTd>
                    <MudTd DataLabel="Cost" Align="Align.Right">
                        @if (isEditing && context.Type == "Generator" && context.SourceItem is Generator generator)
                        {
                            <MudStack Spacing="2">
                                @{
                                    var editCostResources = GetOrCreateEditCostResources(generator);
                                }
                                @foreach (var cost in editCostResources)
                                {
                                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <MudSelect T="string" @bind-Value="@cost.ResourceName" Label="Resource" 
                                                 Variant="Variant.Outlined" Style="flex: 1;">
                                            <MudSelectItem Value="@((string?)null)">Select Resource</MudSelectItem>
                                            @foreach (var res in CalculationService.Resources)
                                            {
                                                <MudSelectItem Value="@res.Name">@res.Name</MudSelectItem>
                                            }
                                        </MudSelect>
                                        <MudNumericField @bind-Value="@cost.Value" Label="Cost Amount" 
                                                       Variant="Variant.Outlined" Min="0.01" Style="flex: 1;" />
                                        <MudSelect T="string" @bind-Value="@cost.Abbr" Label="Abbr" 
                                                 Variant="Variant.Outlined" Style="width: 100px;" Dense="true">
                                            <MudSelectItem Value="@((string?)null)">None</MudSelectItem>
                                            <MudSelectItem Value="@("K")">K</MudSelectItem>
                                            <MudSelectItem Value="@("M")">M</MudSelectItem>
                                            <MudSelectItem Value="@("B")">B</MudSelectItem>
                                            <MudSelectItem Value="@("T")">T</MudSelectItem>
                                            <MudSelectItem Value="@("Qa")">Qa</MudSelectItem>
                                            <MudSelectItem Value="@("Qi")">Qi</MudSelectItem>
                                            <MudSelectItem Value="@("Sx")">Sx</MudSelectItem>
                                            <MudSelectItem Value="@("Sp")">Sp</MudSelectItem>
                                            <MudSelectItem Value="@("Oc")">Oc</MudSelectItem>
                                        </MudSelect>
                                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Error" 
                                                 OnClick="() => RemoveEditCostResource(generator, cost)">
                                            Remove
                                        </MudButton>
                                    </MudStack>
                                }
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                         StartIcon="@Icons.Material.Filled.Add" OnClick="() => AddEditCostResource(generator)" Class="mb-2">
                                    Add Resource Cost
                                </MudButton>
                                <MudNumericField Value="@GetOrCreateEditCostRatio(generator)"
                                                 ValueChanged="@((double value) => { editCostRatios[generator] = value; })"
                                                 Label="CostRatio"
                                                 Variant="Variant.Outlined"
                                                 Dense="true"
                                                 Min="1.0"
                                                 Max="10.0"
                                                 Step="0.01" />
                            </MudStack>
                        }
                        else if (isEditing && context.Type == "Research" && context.SourceItem is Research research)
                        {
                            <MudStack Spacing="2">
                                @{
                                    var editResearchCostResources = GetOrCreateEditCostResources(research);
                                }
                                @foreach (var cost in editResearchCostResources)
                                {
                                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <MudSelect T="string" @bind-Value="@cost.ResourceName" Label="Resource" 
                                                 Variant="Variant.Outlined" Style="flex: 1;">
                                            @foreach (var res in CalculationService.Resources)
                                            {
                                                <MudSelectItem Value="@res.Name">@res.Name</MudSelectItem>
                                            }
                                        </MudSelect>
                                        <MudNumericField @bind-Value="@cost.Value" Label="Cost Amount" 
                                                       Variant="Variant.Outlined" Min="0.01" Style="flex: 1;" />
                                        <MudSelect T="string" @bind-Value="@cost.Abbr" Label="Abbr" 
                                                 Variant="Variant.Outlined" Style="width: 100px;" Dense="true">
                                            <MudSelectItem Value="@((string?)null)">None</MudSelectItem>
                                            <MudSelectItem Value="@("K")">K</MudSelectItem>
                                            <MudSelectItem Value="@("M")">M</MudSelectItem>
                                            <MudSelectItem Value="@("B")">B</MudSelectItem>
                                            <MudSelectItem Value="@("T")">T</MudSelectItem>
                                            <MudSelectItem Value="@("Qa")">Qa</MudSelectItem>
                                            <MudSelectItem Value="@("Qi")">Qi</MudSelectItem>
                                            <MudSelectItem Value="@("Sx")">Sx</MudSelectItem>
                                            <MudSelectItem Value="@("Sp")">Sp</MudSelectItem>
                                            <MudSelectItem Value="@("Oc")">Oc</MudSelectItem>
                                        </MudSelect>
                                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Error" 
                                                 OnClick="() => RemoveEditCostResource(research, cost)">
                                            Remove
                                        </MudButton>
                                    </MudStack>
                                }
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                         StartIcon="@Icons.Material.Filled.Add" OnClick="() => AddEditCostResource(research)" Class="mb-2">
                                    Add Resource Cost
                                </MudButton>
                            </MudStack>
                        }
                        else if (isEditing)
                        {
                            <div>
                                <MudStack Row="true" Spacing="2">
                                    <MudNumericField @bind-Value="@editItem.Cost"
                                                     Label="Cost"
                                                     Variant="Variant.Outlined"
                                                     Dense="true"
                                                     Style="flex: 1;" />
                                    <MudSelect T="string" @bind-Value="@editCostAbbr" Label="Abbr" Variant="Variant.Outlined"
                                               Style="width: 100px;" Dense="true">
                                        <MudSelectItem Value="@((string?)null)">None</MudSelectItem>
                                        <MudSelectItem Value="@("K")">K</MudSelectItem>
                                        <MudSelectItem Value="@("M")">M</MudSelectItem>
                                        <MudSelectItem Value="@("B")">B</MudSelectItem>
                                        <MudSelectItem Value="@("T")">T</MudSelectItem>
                                        <MudSelectItem Value="@("Qa")">Qa</MudSelectItem>
                                        <MudSelectItem Value="@("Qi")">Qi</MudSelectItem>
                                        <MudSelectItem Value="@("Sx")">Sx</MudSelectItem>
                                        <MudSelectItem Value="@("Sp")">Sp</MudSelectItem>
                                        <MudSelectItem Value="@("Oc")">Oc</MudSelectItem>
                                        <MudSelectItem Value="@("No")">No</MudSelectItem>
                                    </MudSelect>
                                </MudStack>
                                
                                <div class="text-caption mt-1">Formatted: @FormatNumber(editItem.Cost)</div>
                            </div>
                        }
                        else
                        {
                            @if (context.ResourceCosts != null && context.ResourceCosts.Count > 0)
                            {
                                <MudStack Spacing="1">
                                    @foreach (var cost in context.ResourceCosts)
                                    {
                                        <div>
                                            <strong>@cost.Key:</strong> @FormatNumber(cost.Value, 2)
                                        </div>
                                    }
                                </MudStack>
                            }
                            else
                            {
                                <div>
                                    <MudText Typo="Typo.body1" Style="font-weight: bold;">@FormatNumber(context.Cost)</MudText>
                                </div>
                            }
                        }
                    </MudTd>
                    <MudTd DataLabel="Gain" Align="Align.Right">
                        @if (context.GainByResource != null && context.GainByResource.Count > 0)
                        {
                            <MudStack Spacing="1">
                                @foreach (var gain in context.GainByResource)
                                {
                                    @if (gain.Value != 0)
                                    {
                                        <div>
                                            <strong>@gain.Key:</strong> @FormatNumber(gain.Value, 2)
                                        </div>
                                    }
                                }
                            </MudStack>
                        }
                        else
                        {
                            <div>
                                <MudText Typo="Typo.body1" Style="font-weight: bold;">@FormatNumber(context.Gain, 2)</MudText>
                            </div>
                        }
                    </MudTd>
                    <MudTd DataLabel="Cascade Score" Align="Align.Right">
                        <MudChip Size="Size.Small" Color="@GetCascadeScoreColor(context.CascadeScore)">
                            @FormatNumber(context.CascadeScore, 4)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Timer" Align="Align.Center">
                        @{
                            var timeToAfford = GetTimeToAfford(context);
                        }
                        @if (timeToAfford == int.MaxValue)
                        {
                            <MudChip Size="Size.Small" Color="Color.Error">
                                Can't Afford
                            </MudChip>
                        }
                        else if (timeToAfford > 0)
                        {
                            <MudChip Size="Size.Small" Color="Color.Warning">
                                @FormatTime(timeToAfford)
                            </MudChip>
                        }
                        else
                        {
                            <MudChip Size="Size.Small" Color="Color.Success">
                                Ready
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        @if (isEditing)
                        {
                            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.Save" 
                                       OnClick="async () => await SaveEdit(context)" Class="mr-1">
                                Update
                            </MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default" 
                                       StartIcon="@Icons.Material.Filled.Refresh" 
                                       OnClick="() => CancelEdit(context)" Class="mr-1">
                                Cancel
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success" 
                                       StartIcon="@Icons.Material.Filled.ShoppingCart" 
                                       OnClick="async () => await ApplyPurchase(context)" Class="mr-1">
                                Apply
                            </MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.Edit" 
                                       OnClick="() => StartEdit(context)" Class="mr-1">
                                Edit
                            </MudButton>
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" 
                                       StartIcon="@Icons.Material.Filled.Delete" 
                                       OnClick="async () => await DeleteItem(context)">
                                Delete
                            </MudButton>
                        }
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private List<UpgradeResult> rankedUpgrades = new();
    private Dictionary<object, UpgradeResult> editItems = new();
    private Dictionary<string, DateTime> timerStartTimes = new();
    private System.Threading.Timer? _timer;
    private double _lastTotalProduction = 0;
    private const double ProductionPerSecond = 1.0; // Production rate per second
    private string? editCostAbbr = null;
    private InputFile fileInputElement = default!;
    private bool hasUserId = false;
    private string? currentUserId = null;
    private class ResourceEntry
    {
        public string? ResourceName { get; set; }
        public double Value { get; set; } = 0;
        public string? Abbr { get; set; }
    }

    private class ResourceCostEntry
    {
        public string? ResourceName { get; set; }
        public double Value { get; set; } = 0;
        public string? Abbr { get; set; }
    }

    private Dictionary<Generator, List<ResourceEntry>> editResources = new();
    private Dictionary<Generator, List<ResourceCostEntry>> editCostResources = new();
    private Dictionary<Research, List<ResourceCostEntry>> editResearchCostResources = new();
    private Dictionary<Generator, double> editCostRatios = new();

    protected override async Task OnInitializedAsync()
    {
        // Check for user ID in LocalStorage first
        hasUserId = await LocalStorageService.HasUserIdAsync();
        if (hasUserId)
        {
            // User ID exists in LocalStorage, load it
            currentUserId = await LocalStorageService.GetUserIdAsync();
            // LoadStateAsync in InitializeAsync will automatically load from cloud if user ID is set
        }
        // Do not show dialog if user ID already exists in LocalStorage
        
        await CalculationService.InitializeAsync();
        RefreshRankings();
        _lastTotalProduction = CalculationService.GetTotalProduction();
        
        // Initialize timer to update every second
        _timer = new System.Threading.Timer(TimerCallback, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void RefreshRankings()
    {
        rankedUpgrades = CalculationService.GetRankedUpgrades();
        // Clear edit items for items that no longer exist
        var currentSourceItems = rankedUpgrades.Select(r => r.SourceItem).Where(s => s != null).ToList();
        var keysToRemove = editItems.Keys.Where(k => !currentSourceItems.Contains(k)).ToList();
        foreach (var key in keysToRemove)
        {
            editItems.Remove(key);
            if (key is Generator generator)
            {
                if (editResources.ContainsKey(generator))
                {
                    editResources.Remove(generator);
                }
                if (editCostResources.ContainsKey(generator))
                {
                    editCostResources.Remove(generator);
                }
                if (editCostRatios.ContainsKey(generator))
                {
                    editCostRatios.Remove(generator);
                }
            }
            else if (key is Research research)
            {
                if (editResearchCostResources.ContainsKey(research))
                {
                    editResearchCostResources.Remove(research);
                }
            }
        }
        // Clear timer cache to force recalculation
        timerStartTimes.Clear();
        StateHasChanged();
    }

    private bool IsEditing(UpgradeResult item)
    {
        return item.SourceItem != null && editItems.ContainsKey(item.SourceItem);
    }

    private void StartEdit(UpgradeResult item)
    {
        if (item.SourceItem == null) return;

        if (!editItems.ContainsKey(item.SourceItem))
        {
            editItems[item.SourceItem] = new UpgradeResult
            {
                ItemName = item.ItemName,
                Type = item.Type,
                Cost = item.Cost,
                ResourceCosts = item.ResourceCosts != null ? new Dictionary<string, double>(item.ResourceCosts) : null,
                Gain = item.Gain,
                BaseProduction = item.SourceItem is Generator gen ? gen.BaseProduction : 0,
                Count = item.SourceItem is Generator gen2 ? gen2.Count : 0,
                TargetGenerators = item.TargetGenerators,
                SourceItem = item.SourceItem
            };

            // Initialize resource entries for generators
            if (item.SourceItem is Generator generator)
            {
                if (!editResources.ContainsKey(generator))
                {
                    var resourceEntries = new List<ResourceEntry>();
                    if (generator.Resources != null && generator.Resources.Count > 0)
                    {
                        // Convert generator Resources to ResourceEntry list
                        foreach (var resource in generator.Resources)
                        {
                            double value = resource.Value;
                            string? abbr = null;
                            double baseValue = value;
                            
                            // Determine abbreviation from value and calculate base value
                            if (value >= 1e27 && value % 1e27 < 1e24)
                            {
                                abbr = "Oc";
                                baseValue = value / 1e27;
                            }
                            else if (value >= 1e24 && value % 1e24 < 1e21)
                            {
                                abbr = "Sp";
                                baseValue = value / 1e24;
                            }
                            else if (value >= 1e21 && value % 1e21 < 1e18)
                            {
                                abbr = "Sx";
                                baseValue = value / 1e21;
                            }
                            else if (value >= 1e18 && value % 1e18 < 1e15)
                            {
                                abbr = "Qi";
                                baseValue = value / 1e18;
                            }
                            else if (value >= 1e15 && value % 1e15 < 1e12)
                            {
                                abbr = "Qa";
                                baseValue = value / 1e15;
                            }
                            else if (value >= 1e12 && value % 1e12 < 1e9)
                            {
                                abbr = "T";
                                baseValue = value / 1e12;
                            }
                            else if (value >= 1e9 && value % 1e9 < 1e6)
                            {
                                abbr = "B";
                                baseValue = value / 1e9;
                            }
                            else if (value >= 1e6 && value % 1e6 < 1e3)
                            {
                                abbr = "M";
                                baseValue = value / 1e6;
                            }
                            else if (value >= 1e3 && value % 1e3 < 1)
                            {
                                abbr = "K";
                                baseValue = value / 1e3;
                            }

                            resourceEntries.Add(new ResourceEntry
                            {
                                ResourceName = resource.Key,
                                Value = baseValue,
                                Abbr = abbr
                            });
                        }
                    }
                    editResources[generator] = resourceEntries;
                }

                // Initialize resource cost entries for generators
                if (!editCostResources.ContainsKey(generator))
                {
                    var costEntries = new List<ResourceCostEntry>();
                    if (generator.ResourceCosts != null && generator.ResourceCosts.Count > 0)
                    {
                        // Convert generator ResourceCosts to ResourceCostEntry list
                        foreach (var cost in generator.ResourceCosts)
                        {
                            double value = cost.Value;
                            string? abbr = null;
                            double baseValue = value;
                            
                            // Determine abbreviation from value and calculate base value
                            if (value >= 1e27 && value % 1e27 < 1e24)
                            {
                                abbr = "Oc";
                                baseValue = value / 1e27;
                            }
                            else if (value >= 1e24 && value % 1e24 < 1e21)
                            {
                                abbr = "Sp";
                                baseValue = value / 1e24;
                            }
                            else if (value >= 1e21 && value % 1e21 < 1e18)
                            {
                                abbr = "Sx";
                                baseValue = value / 1e21;
                            }
                            else if (value >= 1e18 && value % 1e18 < 1e15)
                            {
                                abbr = "Qi";
                                baseValue = value / 1e18;
                            }
                            else if (value >= 1e15 && value % 1e15 < 1e12)
                            {
                                abbr = "Qa";
                                baseValue = value / 1e15;
                            }
                            else if (value >= 1e12 && value % 1e12 < 1e9)
                            {
                                abbr = "T";
                                baseValue = value / 1e12;
                            }
                            else if (value >= 1e9 && value % 1e9 < 1e6)
                            {
                                abbr = "B";
                                baseValue = value / 1e9;
                            }
                            else if (value >= 1e6 && value % 1e6 < 1e3)
                            {
                                abbr = "M";
                                baseValue = value / 1e6;
                            }
                            else if (value >= 1e3 && value % 1e3 < 1)
                            {
                                abbr = "K";
                                baseValue = value / 1e3;
                            }

                            costEntries.Add(new ResourceCostEntry
                            {
                                ResourceName = cost.Key,
                                Value = baseValue,
                                Abbr = abbr
                            });
                        }
                    }
                    editCostResources[generator] = costEntries;
                }

                // Initialize CostRatio for generators
                if (!editCostRatios.ContainsKey(generator))
                {
                    editCostRatios[generator] = generator.CostRatio > 0 ? generator.CostRatio : 1.15;
                }
            }
            else if (item.SourceItem is Research research)
            {
                // Initialize resource cost entries for research
                if (!editResearchCostResources.ContainsKey(research))
                {
                    var costEntries = new List<ResourceCostEntry>();
                    if (research.ResourceCosts != null && research.ResourceCosts.Count > 0)
                    {
                        // Convert research ResourceCosts to ResourceCostEntry list
                        foreach (var cost in research.ResourceCosts)
                        {
                            double value = cost.Value;
                            string? abbr = null;
                            double baseValue = value;
                            
                            // Determine abbreviation from value and calculate base value
                            if (value >= 1e27 && value % 1e27 < 1e24)
                            {
                                abbr = "Oc";
                                baseValue = value / 1e27;
                            }
                            else if (value >= 1e24 && value % 1e24 < 1e21)
                            {
                                abbr = "Sp";
                                baseValue = value / 1e24;
                            }
                            else if (value >= 1e21 && value % 1e21 < 1e18)
                            {
                                abbr = "Sx";
                                baseValue = value / 1e21;
                            }
                            else if (value >= 1e18 && value % 1e18 < 1e15)
                            {
                                abbr = "Qi";
                                baseValue = value / 1e18;
                            }
                            else if (value >= 1e15 && value % 1e15 < 1e12)
                            {
                                abbr = "Qa";
                                baseValue = value / 1e15;
                            }
                            else if (value >= 1e12 && value % 1e12 < 1e9)
                            {
                                abbr = "T";
                                baseValue = value / 1e12;
                            }
                            else if (value >= 1e9 && value % 1e9 < 1e6)
                            {
                                abbr = "B";
                                baseValue = value / 1e9;
                            }
                            else if (value >= 1e6 && value % 1e6 < 1e3)
                            {
                                abbr = "M";
                                baseValue = value / 1e6;
                            }
                            else if (value >= 1e3 && value % 1e3 < 1)
                            {
                                abbr = "K";
                                baseValue = value / 1e3;
                            }

                            costEntries.Add(new ResourceCostEntry
                            {
                                ResourceName = cost.Key,
                                Value = baseValue,
                                Abbr = abbr
                            });
                        }
                    }
                    editResearchCostResources[research] = costEntries;
                }
            }
        }
        StateHasChanged();
    }

    private UpgradeResult GetOrCreateEditItem(UpgradeResult item)
    {
        if (item.SourceItem == null) return item;

        return editItems[item.SourceItem];
    }

    private List<ResourceEntry> GetOrCreateEditResources(Generator generator)
    {
        if (!editResources.ContainsKey(generator))
        {
            editResources[generator] = new List<ResourceEntry>();
        }
        return editResources[generator];
    }

    private void AddEditResource(Generator generator)
    {
        var resources = GetOrCreateEditResources(generator);
        resources.Add(new ResourceEntry { ResourceName = null, Value = 0 });
        StateHasChanged();
    }

    private void RemoveEditResource(Generator generator, ResourceEntry resource)
    {
        var resources = GetOrCreateEditResources(generator);
        resources.Remove(resource);
        StateHasChanged();
    }

    private List<ResourceCostEntry> GetOrCreateEditCostResources(Generator generator)
    {
        if (!editCostResources.ContainsKey(generator))
        {
            editCostResources[generator] = new List<ResourceCostEntry>();
        }
        return editCostResources[generator];
    }

    private void AddEditCostResource(Generator generator)
    {
        var costResources = GetOrCreateEditCostResources(generator);
        costResources.Add(new ResourceCostEntry { ResourceName = null, Value = 0 });
        StateHasChanged();
    }

    private void RemoveEditCostResource(Generator generator, ResourceCostEntry cost)
    {
        var costResources = GetOrCreateEditCostResources(generator);
        costResources.Remove(cost);
        StateHasChanged();
    }

    private List<ResourceCostEntry> GetOrCreateEditCostResources(Research research)
    {
        if (!editResearchCostResources.ContainsKey(research))
        {
            editResearchCostResources[research] = new List<ResourceCostEntry>();
        }
        return editResearchCostResources[research];
    }

    private void AddEditCostResource(Research research)
    {
        var costResources = GetOrCreateEditCostResources(research);
        costResources.Add(new ResourceCostEntry { ResourceName = null, Value = 0 });
        StateHasChanged();
    }

    private void RemoveEditCostResource(Research research, ResourceCostEntry cost)
    {
        var costResources = GetOrCreateEditCostResources(research);
        costResources.Remove(cost);
        StateHasChanged();
    }

    private double GetOrCreateEditCostRatio(Generator generator)
    {
        if (!editCostRatios.ContainsKey(generator))
        {
            editCostRatios[generator] = generator.CostRatio > 0 ? generator.CostRatio : 1.15;
        }
        return editCostRatios[generator];
    }

    private async Task ApplyPurchase(UpgradeResult upgrade)
    {
        // Check if this is a Generator with CostRatio == 0
        if (upgrade.SourceItem is Generator generator && generator.CostRatio <= 0)
        {
            // Show dialog to get new cost
            var parameters = new DialogParameters
            {
                ["CalculationService"] = CalculationService,
                ["CurrentCost"] = generator.Cost
            };

            var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
            var dialog = await DialogService.ShowAsync<NewCostDialog>("Enter New Cost", parameters, options);
            var result = await dialog.Result;

            if (result.Canceled)
            {
                return; // User cancelled, don't apply purchase
            }

            // Calculate CostRatio from new cost
            if (result.Data is double newCost && newCost > 0)
            {
                generator.CostRatio = newCost / generator.Cost;
            }
            else
            {
                Snackbar.Add("Invalid cost entered", Severity.Error);
                return;
            }
        }

        await CalculationService.AppliedPurchaseAsync(upgrade);
        RefreshRankings();
        Snackbar.Add($"Applied purchase: {upgrade.ItemName}", Severity.Success);
    }

    private async Task SaveEdit(UpgradeResult item)
    {
        if (item.SourceItem == null || !editItems.ContainsKey(item.SourceItem)) return;

        var editItem = editItems[item.SourceItem];

        if (item.SourceItem is Generator generator)
        {
            generator.Name = editItem.ItemName;
            generator.Count = editItem.Count;

            // Handle resource costs
            if (editCostResources.ContainsKey(generator) && editCostResources[generator].Count > 0)
            {
                generator.ResourceCosts = new Dictionary<string, double>();
                foreach (var cost in editCostResources[generator])
                {
                    if (!string.IsNullOrWhiteSpace(cost.ResourceName) && cost.Value > 0)
                    {
                        double costValue = CalculationService.ApplyAbbreviation(cost.Value, cost.Abbr);
                        generator.ResourceCosts[cost.ResourceName] = costValue;
                    }
                }
                generator.Cost = generator.ResourceCosts.Count > 0 
                    ? generator.ResourceCosts.Values.Sum() 
                    : 0;
            }
            else
            {
                generator.ResourceCosts.Clear();
                generator.Cost = 0;
            }

            // Handle resources for production
            if (editResources.ContainsKey(generator) && editResources[generator].Count > 0)
            {
                generator.Resources = new Dictionary<string, double>();
                foreach (var resource in editResources[generator])
                {
                    if (!string.IsNullOrWhiteSpace(resource.ResourceName) && resource.Value > 0)
                    {
                        double productionValue = CalculationService.ApplyAbbreviation(resource.Value, resource.Abbr);
                        generator.Resources[resource.ResourceName] = productionValue;
                    }
                }
                generator.BaseProduction = generator.Resources.Count > 0 
                    ? generator.Resources.Values.Sum() 
                    : 0;
            }
            else
            {
                generator.Resources.Clear();
                generator.BaseProduction = 0;
            }

            // Handle CostRatio
            if (editCostRatios.ContainsKey(generator))
            {
                generator.CostRatio = editCostRatios[generator];
            }

            // Remove from edit resources, cost resources, and cost ratios
            editResources.Remove(generator);
            editCostResources.Remove(generator);
            editCostRatios.Remove(generator);
        }
        else if (item.SourceItem is Research research)
        {
            research.Name = editItem.ItemName;

            // Handle resource costs
            if (editResearchCostResources.ContainsKey(research) && editResearchCostResources[research].Count > 0)
            {
                research.ResourceCosts = new Dictionary<string, double>();
                foreach (var cost in editResearchCostResources[research])
                {
                    if (!string.IsNullOrWhiteSpace(cost.ResourceName) && cost.Value > 0)
                    {
                        double costValue = CalculationService.ApplyAbbreviation(cost.Value, cost.Abbr);
                        research.ResourceCosts[cost.ResourceName] = costValue;
                    }
                }
                research.Cost = research.ResourceCosts.Count > 0 
                    ? research.ResourceCosts.Values.Sum() 
                    : 0;
            }
            else
            {
                research.ResourceCosts.Clear();
                research.Cost = 0;
            }

            // Remove from edit research cost resources
            editResearchCostResources.Remove(research);
        }

        // Exit edit mode for this row
        editItems.Remove(item.SourceItem);

        CalculationService.UpdateResourceTotalProduction();
        await CalculationService.SaveStateAsync();
        RefreshRankings();
        Snackbar.Add("Item updated successfully", Severity.Success);
    }

    private void CancelEdit(UpgradeResult item)
    {
        if (item.SourceItem != null)
        {
            if (editItems.ContainsKey(item.SourceItem))
            {
                editItems.Remove(item.SourceItem);
            }
            if (item.SourceItem is Generator generator)
            {
                if (editResources.ContainsKey(generator))
                {
                    editResources.Remove(generator);
                }
                if (editCostResources.ContainsKey(generator))
                {
                    editCostResources.Remove(generator);
                }
                if (editCostRatios.ContainsKey(generator))
                {
                    editCostRatios.Remove(generator);
                }
            }
            else if (item.SourceItem is Research research)
            {
                if (editResearchCostResources.ContainsKey(research))
                {
                    editResearchCostResources.Remove(research);
                }
            }
        }
        RefreshRankings();
    }

    private async Task DeleteItem(UpgradeResult item)
    {
        if (item.SourceItem is Generator generator)
        {
            CalculationService.Generators.Remove(generator);
        }
        else if (item.SourceItem is Research research)
        {
            CalculationService.Research.Remove(research);
        }

        await CalculationService.SaveStateAsync();
        RefreshRankings();
        Snackbar.Add("Item deleted successfully", Severity.Info);
    }

    private Color GetCascadeScoreColor(double cascadeScore)
    {
        if (cascadeScore > 10) return Color.Success;
        if (cascadeScore > 1) return Color.Warning;
        if (cascadeScore > 0) return Color.Info;
        return Color.Default;
    }

    private double GetGeneratorContribution(Generator generator)
    {
        // BaseProduction already includes all applied research multipliers
        return generator.GetCurrentProduction();
    }

    private string FormatNumber(double value, int decimals = 2)
    {
        if (double.IsNaN(value) || double.IsInfinity(value))
            return "0";

        double absValue = Math.Abs(value);
        string sign = value < 0 ? "-" : "";
        string format = $"F{decimals}";

        if (absValue >= 1e30) // Nonillion
        {
            return $"{sign}{(absValue / 1e30).ToString(format)}No";
        }
        else if (absValue >= 1e27) // Octillion
        {
            return $"{sign}{(absValue / 1e27).ToString(format)}Oc";
        }
        else if (absValue >= 1e24) // Septillion
        {
            return $"{sign}{(absValue / 1e24).ToString(format)}Sp";
        }
        else if (absValue >= 1e21) // Sextillion
        {
            return $"{sign}{(absValue / 1e21).ToString(format)}Sx";
        }
        else if (absValue >= 1e18) // Quintillion
        {
            return $"{sign}{(absValue / 1e18).ToString(format)}Qi";
        }
        else if (absValue >= 1e15) // Quadrillion
        {
            return $"{sign}{(absValue / 1e15).ToString(format)}Qa";
        }
        else if (absValue >= 1e12) // Trillion
        {
            return $"{sign}{(absValue / 1e12).ToString(format)}T";
        }
        else if (absValue >= 1e9) // Billion
        {
            return $"{sign}{(absValue / 1e9).ToString(format)}B";
        }
        else if (absValue >= 1e6) // Million
        {
            return $"{sign}{(absValue / 1e6).ToString(format)}M";
        }
        else if (absValue >= 1e3) // Thousand
        {
            return $"{sign}{(absValue / 1e3).ToString(format)}K";
        }
        else
        {
            return $"{sign}{absValue.ToString(format)}";
        }
    }

    private async Task OpenAddGeneratorDialog()
    {
        var parameters = new DialogParameters
        {
            ["CalculationService"] = CalculationService
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddGeneratorDialog>("Add Generator", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            RefreshRankings();
        }
    }

    private async Task OpenAddResearchDialog()
    {
        var parameters = new DialogParameters
        {
            ["CalculationService"] = CalculationService
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddResearchDialog>("Add Research", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            RefreshRankings();
        }
    }

    private async Task OpenAddResourceDialog()
    {
        var parameters = new DialogParameters
        {
            ["CalculationService"] = CalculationService
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddResourceDialog>("Add Resource", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            CalculationService.UpdateResourceTotalProduction();
            RefreshRankings();
            StateHasChanged();
        }
    }

    private async Task DeleteResource(Resource resource)
    {
        CalculationService.RemoveResource(resource);
        CalculationService.UpdateResourceTotalProduction();
        await CalculationService.SaveStateAsync();
        RefreshRankings();
        Snackbar.Add("Resource deleted successfully", Severity.Info);
    }

    private async Task OpenDeleteAllDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DeleteAllConfirmationDialog>("Delete All Items", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await CalculationService.ClearAllAsync();
            RefreshRankings();
            Snackbar.Add("All items deleted successfully", Severity.Info);
        }
    }

    private async Task DownloadSaveFiles()
    {
        try
        {
            await LocalStorageService.ExportGeneratorsToFileAsync(CalculationService.Generators);
            await LocalStorageService.ExportResearchToFileAsync(CalculationService.Research);
            Snackbar.Add("CSV files downloaded successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading files: {ex.Message}", Severity.Error);
        }
    }

    private async Task TriggerFileInput()
    {
        // Use direct DOM manipulation which is more reliable
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('csvFileInput')?.click();");
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            bool generatorsImported = false;
            bool researchImported = false;

            foreach (var file in e.GetMultipleFiles())
            {
                var fileName = file.Name.ToLower();
                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB max
                using var reader = new StreamReader(stream);
                var csvContent = await reader.ReadToEndAsync();

                if (fileName.Contains("generator"))
                {
                    await LocalStorageService.ImportGeneratorsFromFileAsync(csvContent);
                    generatorsImported = true;
                }
                else if (fileName.Contains("research"))
                {
                    await LocalStorageService.ImportResearchFromFileAsync(csvContent);
                    researchImported = true;
                }
            }

            // Reload the state from storage
            await CalculationService.LoadStateAsync();
            
            // Update total production to trigger recalculation
            _lastTotalProduction = CalculationService.GetTotalProduction();
            
            // Refresh rankings to recalculate cascade scores and timers
            RefreshRankings();
            
            // Force state update to ensure UI reflects new data
            StateHasChanged();

            if (generatorsImported && researchImported)
            {
                Snackbar.Add("Both CSV files imported successfully", Severity.Success);
            }
            else if (generatorsImported)
            {
                Snackbar.Add("Generators CSV file imported successfully", Severity.Success);
            }
            else if (researchImported)
            {
                Snackbar.Add("Research CSV file imported successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("No valid CSV files found. Please select generators.csv or research.csv", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error importing files: {ex.Message}", Severity.Error);
        }
    }

    private void TimerCallback(object? state)
    {
        InvokeAsync(() =>
        {
            // Check if total production changed
            var currentProduction = CalculationService.GetTotalProduction();
            if (Math.Abs(currentProduction - _lastTotalProduction) > 0.001)
            {
                _lastTotalProduction = currentProduction;
                // Clear timer cache to force recalculation
                timerStartTimes.Clear();
            }
            StateHasChanged();
        });
    }

    private int GetTimeToAfford(UpgradeResult item)
    {
        double timeNeeded = double.MaxValue;
        
        // Check if item has resource costs
        if (item.ResourceCosts != null && item.ResourceCosts.Count > 0)
        {
            // Multiple resource costs - find the bottleneck (longest time to afford)
            var productionByResource = CalculationService.GetTotalProductionByResource();
            double maxTime = 0;
            
            foreach (var cost in item.ResourceCosts)
            {
                if (productionByResource.ContainsKey(cost.Key))
                {
                    double resourceProduction = productionByResource[cost.Key];
                    if (resourceProduction > 0)
                    {
                        double resourceTime = cost.Value / resourceProduction;
                        if (resourceTime > maxTime)
                        {
                            maxTime = resourceTime;
                        }
                    }
                    else
                    {
                        // Resource not being produced - can't afford
                        return int.MaxValue;
                    }
                }
                else
                {
                    // Resource not being produced - can't afford
                    return int.MaxValue;
                }
            }
            
            timeNeeded = maxTime;
        }
        else
        {
            var totalProduction = CalculationService.GetTotalProduction();
            
            // If no production, return a large number
            if (totalProduction <= 0)
            {
                return int.MaxValue;
            }
            
            // Calculate production per second (assuming total production is per second)
            var productionPerSecond = totalProduction * ProductionPerSecond;
            
            // Calculate time needed to afford this item (in seconds)
            timeNeeded = item.Cost / productionPerSecond;
        }
        
        // Get the timer key for this item
        var timerKey = $"{item.Type}_{item.ItemName}";
        
        // Check if we need to recalculate (production changed or timer expired)
        var needsRecalculation = !timerStartTimes.ContainsKey(timerKey);
        
        if (!needsRecalculation)
        {
            var endTime = timerStartTimes[timerKey];
            var elapsed = (DateTime.Now - (endTime.AddSeconds(-timeNeeded))).TotalSeconds;
            
            // Recalculate time needed with current production
            double currentTimeNeeded = double.MaxValue;
            if (item.ResourceCosts != null && item.ResourceCosts.Count > 0)
            {
                var productionByResource = CalculationService.GetTotalProductionByResource();
                double maxTime = 0;
                
                foreach (var cost in item.ResourceCosts)
                {
                    if (productionByResource.ContainsKey(cost.Key))
                    {
                        double resourceProduction = productionByResource[cost.Key];
                        if (resourceProduction > 0)
                        {
                            double resourceTime = cost.Value / resourceProduction;
                            if (resourceTime > maxTime)
                            {
                                maxTime = resourceTime;
                            }
                        }
                        else
                        {
                            currentTimeNeeded = double.MaxValue;
                            break;
                        }
                    }
                    else
                    {
                        currentTimeNeeded = double.MaxValue;
                        break;
                    }
                }
                
                if (currentTimeNeeded != double.MaxValue)
                {
                    currentTimeNeeded = maxTime;
                }
            }
            else
            {
                var totalProduction = CalculationService.GetTotalProduction();
                if (totalProduction > 0)
                {
                    var productionPerSecond = totalProduction * ProductionPerSecond;
                    currentTimeNeeded = item.Cost / productionPerSecond;
                }
            }
            
            // Recalculate if production changed significantly (more than 1% difference)
            if (currentTimeNeeded != double.MaxValue && timeNeeded != double.MaxValue &&
                Math.Abs(currentTimeNeeded - timeNeeded) / Math.Max(currentTimeNeeded, 1) > 0.01)
            {
                needsRecalculation = true;
            }
        }
        
        if (needsRecalculation)
        {
            // Recalculate based on current production
            if (item.AvailableAt.HasValue)
            {
                timerStartTimes[timerKey] = item.AvailableAt.Value;
            }
        }
        
        if (!item.AvailableAt.HasValue)
        {
            return int.MaxValue; // Can't afford
        }
        
        var remaining = (int)(item.AvailableAt.Value - DateTime.Now).TotalSeconds;
        return Math.Max(0, remaining);
    }

    private string FormatTime(int seconds)
    {
        if (seconds < 60)
        {
            return $"{seconds}s";
        }
        else
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            return $"{minutes}m {secs}s";
        }
    }

    private async Task OpenUserIdDialog()
    {
        var currentId = await LocalStorageService.GetUserIdAsync();
        var hasExistingUserId = !string.IsNullOrEmpty(currentId);
        
        var parameters = new DialogParameters
        {
            ["LocalStorageService"] = LocalStorageService,
            ["CurrentUserId"] = currentId
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UserIdDialog>("Set User ID", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            hasUserId = await LocalStorageService.HasUserIdAsync();
            var newUserId = await LocalStorageService.GetUserIdAsync();
            
            if (hasExistingUserId)
            {
                // Existing username in local storage - keep current name changing logic
                // (check for existing username on cloud and alert if overwriting)
                // This is already handled in UserIdDialog
                var isChangingUser = newUserId != currentId;
                if (isChangingUser)
                {
                    // User changed to a different username - load data from cloud for new username
                    await LoadUserDataFromCloud();
                    Snackbar.Add("User ID changed and data loaded from cloud", Severity.Success);
                }
                else
                {
                    // Same username, just updated
                    Snackbar.Add("User ID saved successfully", Severity.Success);
                }
            }
            else
            {
                // No existing username in local storage - get user data from cloud with input username
                if (hasUserId && !string.IsNullOrEmpty(newUserId))
                {
                    await LoadUserDataFromCloud();
                    Snackbar.Add("User data loaded from cloud", Severity.Success);
                }
            }
            
            currentUserId = newUserId;
            StateHasChanged();
        }
    }

    private async Task CreateNewUserProfile()
    {
        // Ask if user wants to keep current data for new user profile
        var keepDataOptions = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var keepDataDialog = await DialogService.ShowAsync<KeepDataForNewProfileDialog>("Create New User Profile", keepDataOptions);
        var keepDataResult = await keepDataDialog.Result;

        if (keepDataResult.Canceled)
        {
            return; // User cancelled
        }

        var keepCurrentData = keepDataResult.Data is bool keepData && keepData;

        // If user chose to clear data, clear all current data
        if (!keepCurrentData)
        {
            CalculationService.Generators.Clear();
            CalculationService.Research.Clear();
            CalculationService.Resources.Clear();
            await CalculationService.SaveStateAsync();
            RefreshRankings();
        }

        // Clear current user ID from LocalStorage
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "userId");
        hasUserId = false;
        currentUserId = null;

        // Open dialog with empty user ID to create new profile
        var parameters = new DialogParameters
        {
            ["LocalStorageService"] = LocalStorageService,
            ["CurrentUserId"] = null
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UserIdDialog>("Create New User Profile", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Update hasUserId and currentUserId to reflect the newly set user ID
            hasUserId = await LocalStorageService.HasUserIdAsync();
            currentUserId = await LocalStorageService.GetUserIdAsync();
            
            await CalculationService.SaveStateAsync();

            Snackbar.Add("New user profile created successfully", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task LoadUserDataFromCloud()
    {
        try
        {
            // Reload state from cloud (which will load from cloud if user ID is set)
            await CalculationService.LoadStateAsync();
            RefreshRankings();
            _lastTotalProduction = CalculationService.GetTotalProduction();
            Snackbar.Add("User data loaded from cloud", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data from cloud: {ex.Message}", Severity.Warning);
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}