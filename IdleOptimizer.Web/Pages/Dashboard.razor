@page "/"
@using IdleOptimizer.Models
@using IdleOptimizer.Services
@using MudBlazor
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject ICalculationService CalculationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILocalStorageService LocalStorageService
@inject IJSRuntime JSRuntime
@implements IDisposable

@using IdleOptimizer.ViewModels

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudCard>
        <MudCardContent>
            <ResourceSummaryTable CalculationService="@CalculationService" 
                                  NumberFormattingService="@NumberFormattingService"
                                  OnDeleteResource="@DeleteResource" />
            
            <ActionButtons OnAddGenerator="@OpenAddGeneratorDialog"
                          OnAddResearch="@OpenAddResearchDialog"
                          OnAddResource="@OpenAddResourceDialog"
                          OnRefresh="@RefreshRankings"
                          OnPrestige="@OpenPrestigeDialog" />

            <UpgradeRankingsTable RankedUpgrades="@rankedUpgrades"
                                  CalculationService="@CalculationService"
                                  NumberFormattingService="@NumberFormattingService"
                                  TimerService="@TimerService"
                                  EditItems="@editItems"
                                  EditResources="@editResources"
                                  EditCostResources="@editCostResources"
                                  EditResearchCostResources="@editResearchCostResources"
                                  EditCostRatios="@editCostRatios"
                                  EditCostAbbr="@editCostAbbr"
                                  OnStartEdit="@StartEdit"
                                  OnSaveEdit="@SaveEdit"
                                  OnCancelEdit="@CancelEdit"
                                  OnDeleteItem="@DeleteItem"
                                  OnApplyPurchase="@ApplyPurchase"
                                  OnEditResourcesChanged="@HandleEditResourcesChanged"
                                  OnEditCostResourcesChanged="@HandleEditCostResourcesChanged"
                                  OnEditResearchCostResourcesChanged="@HandleEditResearchCostResourcesChanged"
                                  OnEditCostRatioChanged="@HandleEditCostRatioChanged"
                                  OnDownloadSaveFiles="@DownloadSaveFiles"
                                  OnTriggerFileInput="@TriggerFileInput"
                                  OnHandleFileUpload="@HandleFileUpload"
                                  OnOpenDeleteAllDialog="@OpenDeleteAllDialog" />
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [Inject] private INumberFormattingService NumberFormattingService { get; set; } = default!;
    [Inject] private IUpgradeTimerService TimerService { get; set; } = default!;
    
    private List<UpgradeResult> rankedUpgrades = new();
    private Dictionary<object, UpgradeResult> editItems = new();
    private string? editCostAbbr = null;
    private Dictionary<Generator, List<ResourceEntryViewModel>> editResources = new();
    private Dictionary<Generator, List<ResourceCostEntryViewModel>> editCostResources = new();
    private Dictionary<Research, List<ResourceCostEntryViewModel>> editResearchCostResources = new();
    private Dictionary<Generator, double> editCostRatios = new();

    protected override async Task OnInitializedAsync()
    {
        await CalculationService.InitializeAsync();
        RefreshRankings();
        
        // Start timer service
        TimerService.TimerTick += OnTimerTick;
        TimerService.StartTimer();
    }

    public void Dispose()
    {
        TimerService.TimerTick -= OnTimerTick;
        TimerService.StopTimer();
    }

    private void OnTimerTick(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void RefreshRankings()
    {
        rankedUpgrades = CalculationService.GetRankedUpgrades();
        // Clear edit items for items that no longer exist
        var currentSourceItems = rankedUpgrades.Select(r => r.SourceItem).Where(s => s != null).ToList();
        var keysToRemove = editItems.Keys.Where(k => !currentSourceItems.Contains(k)).ToList();
        foreach (var key in keysToRemove)
        {
            editItems.Remove(key);
            if (key is Generator generator)
            {
                if (editResources.ContainsKey(generator))
                {
                    editResources.Remove(generator);
                }
                if (editCostResources.ContainsKey(generator))
                {
                    editCostResources.Remove(generator);
                }
                if (editCostRatios.ContainsKey(generator))
                {
                    editCostRatios.Remove(generator);
                }
            }
            else if (key is Research research)
            {
                if (editResearchCostResources.ContainsKey(research))
                {
                    editResearchCostResources.Remove(research);
                }
            }
        }
        // Clear timer cache to force recalculation
        TimerService.ClearCache();
        StateHasChanged();
    }

    private bool IsEditing(UpgradeResult item)
    {
        return item.SourceItem != null && editItems.ContainsKey(item.SourceItem);
    }

    private void StartEdit(UpgradeResult item)
    {
        if (item.SourceItem == null) return;

        if (!editItems.ContainsKey(item.SourceItem))
        {
            editItems[item.SourceItem] = new UpgradeResult
            {
                ItemName = item.ItemName,
                Type = item.Type,
                Cost = item.Cost,
                ResourceCosts = item.ResourceCosts != null ? new Dictionary<string, double>(item.ResourceCosts) : null,
                Gain = item.Gain,
                BaseProduction = item.SourceItem is Generator gen ? gen.BaseProduction : 0,
                Count = item.SourceItem is Generator gen2 ? gen2.Count : 0,
                TargetGenerators = item.TargetGenerators,
                SourceItem = item.SourceItem
            };

            // Initialize resource entries for generators
            if (item.SourceItem is Generator generator)
            {
                if (!editResources.ContainsKey(generator))
                {
                    var resourceEntries = new List<ResourceEntryViewModel>();
                    if (generator.Resources != null && generator.Resources.Count > 0)
                    {
                        // Convert generator Resources to ResourceEntryViewModel list
                        foreach (var resource in generator.Resources)
                        {
                            var (baseValue, abbr) = NumberFormattingService.ParseAbbreviation(resource.Value);
                            
                            resourceEntries.Add(new ResourceEntryViewModel
                            {
                                ResourceName = resource.Key,
                                Value = baseValue,
                                Abbr = abbr
                            });
                        }
                    }
                    editResources[generator] = resourceEntries;
                }

                // Initialize resource cost entries for generators
                if (!editCostResources.ContainsKey(generator))
                {
                    var costEntries = new List<ResourceCostEntryViewModel>();
                    if (generator.ResourceCosts != null && generator.ResourceCosts.Count > 0)
                    {
                        // Convert generator ResourceCosts to ResourceCostEntryViewModel list
                        foreach (var cost in generator.ResourceCosts)
                        {
                            var (baseValue, abbr) = NumberFormattingService.ParseAbbreviation(cost.Value);
                            
                            costEntries.Add(new ResourceCostEntryViewModel
                            {
                                ResourceName = cost.Key,
                                Value = baseValue,
                                Abbr = abbr
                            });
                        }
                    }
                    editCostResources[generator] = costEntries;
                }

                // Initialize CostRatio for generators
                if (!editCostRatios.ContainsKey(generator))
                {
                    editCostRatios[generator] = generator.CostRatio > 0 ? generator.CostRatio : 1.15;
                }
            }
            else if (item.SourceItem is Research research)
            {
                // Initialize resource cost entries for research
                if (!editResearchCostResources.ContainsKey(research))
                {
                    var costEntries = new List<ResourceCostEntryViewModel>();
                    if (research.ResourceCosts != null && research.ResourceCosts.Count > 0)
                    {
                        // Convert research ResourceCosts to ResourceCostEntryViewModel list
                        foreach (var cost in research.ResourceCosts)
                        {
                            var (baseValue, abbr) = NumberFormattingService.ParseAbbreviation(cost.Value);
                            
                            costEntries.Add(new ResourceCostEntryViewModel
                            {
                                ResourceName = cost.Key,
                                Value = baseValue,
                                Abbr = abbr
                            });
                        }
                    }
                    editResearchCostResources[research] = costEntries;
                }
            }
        }
        StateHasChanged();
    }

    private UpgradeResult GetOrCreateEditItem(UpgradeResult item)
    {
        if (item.SourceItem == null) return item;

        return editItems[item.SourceItem];
    }

    private void HandleEditResourcesChanged((Generator generator, List<ResourceEntryViewModel> entries) args)
    {
        editResources[args.generator] = args.entries;
        StateHasChanged();
    }

    private void HandleEditCostResourcesChanged((Generator generator, List<ResourceCostEntryViewModel> entries) args)
    {
        editCostResources[args.generator] = args.entries;
        StateHasChanged();
    }

    private void HandleEditResearchCostResourcesChanged((Research research, List<ResourceCostEntryViewModel> entries) args)
    {
        editResearchCostResources[args.research] = args.entries;
        StateHasChanged();
    }

    private void HandleEditCostRatioChanged((Generator generator, double ratio) args)
    {
        editCostRatios[args.generator] = args.ratio;
        StateHasChanged();
    }

    private async Task ApplyPurchase(UpgradeResult upgrade)
    {
        // Check if this is a Generator with CostRatio == 0
        if (upgrade.SourceItem is Generator generator && generator.CostRatio <= 0)
        {
            // Show dialog to get new cost
            var parameters = new DialogParameters
            {
                ["CalculationService"] = CalculationService,
                ["CurrentCost"] = generator.Cost
            };

            var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
            var dialog = await DialogService.ShowAsync<NewCostDialog>("Enter New Cost", parameters, options);
            var result = await dialog.Result;

            if (result.Canceled)
            {
                return; // User cancelled, don't apply purchase
            }

            // Calculate CostRatio from new cost
            if (result.Data is double newCost && newCost > 0)
            {
                generator.CostRatio = newCost / generator.Cost;
            }
            else
            {
                Snackbar.Add("Invalid cost entered", Severity.Error);
                return;
            }
        }

        CalculationService.AppliedPurchase(upgrade);
        RefreshRankings();
        Snackbar.Add($"Applied purchase: {upgrade.ItemName}", Severity.Success);

        await CalculationService.SaveStateAsync();
    }

    private async Task SaveEdit(UpgradeResult item)
    {
        if (item.SourceItem == null || !editItems.ContainsKey(item.SourceItem)) return;

        var editItem = editItems[item.SourceItem];

        if (item.SourceItem is Generator generator)
        {
            generator.Name = editItem.ItemName;
            generator.Count = editItem.Count;

            // Handle resource costs
            if (editCostResources.ContainsKey(generator) && editCostResources[generator].Count > 0)
            {
                generator.ResourceCosts = new Dictionary<string, double>();
                foreach (var cost in editCostResources[generator])
                {
                    if (!string.IsNullOrWhiteSpace(cost.ResourceName) && cost.Value > 0)
                    {
                        double costValue = NumberFormattingService.ApplyAbbreviation(cost.Value, cost.Abbr);
                        generator.ResourceCosts[cost.ResourceName] = costValue;
                    }
                }
                generator.Cost = generator.ResourceCosts.Count > 0 
                    ? generator.ResourceCosts.Values.Sum() 
                    : 0;
            }
            else
            {
                generator.ResourceCosts.Clear();
                generator.Cost = 0;
            }

            // Handle resources for production
            if (editResources.ContainsKey(generator) && editResources[generator].Count > 0)
            {
                generator.Resources = new Dictionary<string, double>();
                foreach (var resource in editResources[generator])
                {
                    if (!string.IsNullOrWhiteSpace(resource.ResourceName) && resource.Value > 0)
                    {
                        double productionValue = NumberFormattingService.ApplyAbbreviation(resource.Value, resource.Abbr);
                        generator.Resources[resource.ResourceName] = productionValue;
                    }
                }
                generator.BaseProduction = generator.Resources.Count > 0 
                    ? generator.Resources.Values.Sum() 
                    : 0;
            }
            else
            {
                generator.Resources.Clear();
                generator.BaseProduction = 0;
            }

            // Handle CostRatio
            if (editCostRatios.ContainsKey(generator))
            {
                generator.CostRatio = editCostRatios[generator];
            }

            // Initialize BaseResources if not set
            if (generator.BaseResources == null || generator.BaseResources.Count == 0)
            {
                if (generator.Resources != null && generator.Resources.Count > 0)
                {
                    generator.BaseResources = new Dictionary<string, double>(generator.Resources);
                }
                else
                {
                    generator.BaseResources = new Dictionary<string, double>();
                }
            }

            // Initialize BaseResourceCosts if not set
            if (generator.BaseResourceCosts == null || generator.BaseResourceCosts.Count == 0)
            {
                if (generator.ResourceCosts != null && generator.ResourceCosts.Count > 0)
                {
                    generator.BaseResourceCosts = new Dictionary<string, double>(generator.ResourceCosts);
                }
                else
                {
                    generator.BaseResourceCosts = new Dictionary<string, double>();
                }
            }

            // Remove from edit resources, cost resources, and cost ratios
            editResources.Remove(generator);
            editCostResources.Remove(generator);
            editCostRatios.Remove(generator);
        }
        else if (item.SourceItem is Research research)
        {
            research.Name = editItem.ItemName;

            // Handle resource costs
            if (editResearchCostResources.ContainsKey(research) && editResearchCostResources[research].Count > 0)
            {
                research.ResourceCosts = new Dictionary<string, double>();
                foreach (var cost in editResearchCostResources[research])
                {
                    if (!string.IsNullOrWhiteSpace(cost.ResourceName) && cost.Value > 0)
                    {
                        double costValue = NumberFormattingService.ApplyAbbreviation(cost.Value, cost.Abbr);
                        research.ResourceCosts[cost.ResourceName] = costValue;
                    }
                }
                research.Cost = research.ResourceCosts.Count > 0 
                    ? research.ResourceCosts.Values.Sum() 
                    : 0;
            }
            else
            {
                research.ResourceCosts.Clear();
                research.Cost = 0;
            }

            // Remove from edit research cost resources
            editResearchCostResources.Remove(research);
        }

        // Exit edit mode for this row
        editItems.Remove(item.SourceItem);

        CalculationService.UpdateResourceTotalProduction();
        RefreshRankings();
        Snackbar.Add("Item updated successfully", Severity.Success);

        await CalculationService.SaveStateAsync();
    }

    private void CancelEdit(UpgradeResult item)
    {
        if (item.SourceItem != null)
        {
            if (editItems.ContainsKey(item.SourceItem))
            {
                editItems.Remove(item.SourceItem);
            }
            if (item.SourceItem is Generator generator)
            {
                if (editResources.ContainsKey(generator))
                {
                    editResources.Remove(generator);
                }
                if (editCostResources.ContainsKey(generator))
                {
                    editCostResources.Remove(generator);
                }
                if (editCostRatios.ContainsKey(generator))
                {
                    editCostRatios.Remove(generator);
                }
            }
            else if (item.SourceItem is Research research)
            {
                if (editResearchCostResources.ContainsKey(research))
                {
                    editResearchCostResources.Remove(research);
                }
            }
        }
        RefreshRankings();
    }

    private async Task DeleteItem(UpgradeResult item)
    {
        if (item.SourceItem is Generator generator)
        {
            CalculationService.Generators.Remove(generator);
        }
        else if (item.SourceItem is Research research)
        {
            CalculationService.Research.Remove(research);
        }

        RefreshRankings();
        Snackbar.Add("Item deleted successfully", Severity.Info);

        await CalculationService.SaveStateAsync();
    }



    private async Task OpenAddGeneratorDialog()
    {
        var parameters = new DialogParameters
        {
            ["CalculationService"] = CalculationService
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddGeneratorDialog>("Add Generator", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            RefreshRankings();
        }
    }

    private async Task OpenAddResearchDialog()
    {
        var parameters = new DialogParameters
        {
            ["CalculationService"] = CalculationService
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddResearchDialog>("Add Research", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            RefreshRankings();
        }
    }

    private async Task OpenAddResourceDialog()
    {
        var parameters = new DialogParameters
        {
            ["CalculationService"] = CalculationService
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddResourceDialog>("Add Resource", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            CalculationService.UpdateResourceTotalProduction();
            RefreshRankings();
            StateHasChanged();
        }
    }

    private async Task DeleteResource(Resource resource)
    {
        CalculationService.RemoveResource(resource);
        CalculationService.UpdateResourceTotalProduction();
        RefreshRankings();
        Snackbar.Add("Resource deleted successfully", Severity.Info);

        await CalculationService.SaveStateAsync();
    }

    private async Task OpenDeleteAllDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DeleteAllConfirmationDialog>("Delete All Items", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await CalculationService.ClearAllAsync();
            RefreshRankings();
            Snackbar.Add("All items deleted successfully", Severity.Info);
        }
    }

    private async Task DownloadSaveFiles()
    {
        try
        {
            await LocalStorageService.ExportGeneratorsToFileAsync(CalculationService.Generators);
            await LocalStorageService.ExportResearchToFileAsync(CalculationService.Research);
            Snackbar.Add("CSV files downloaded successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading files: {ex.Message}", Severity.Error);
        }
    }

    private async Task TriggerFileInput()
    {
        // Use direct DOM manipulation which is more reliable
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('csvFileInput')?.click();");
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            bool generatorsImported = false;
            bool researchImported = false;

            foreach (var file in e.GetMultipleFiles())
            {
                var fileName = file.Name.ToLower();
                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB max
                using var reader = new StreamReader(stream);
                var csvContent = await reader.ReadToEndAsync();

                if (fileName.Contains("generator"))
                {
                    await LocalStorageService.ImportGeneratorsFromFileAsync(csvContent);
                    generatorsImported = true;
                }
                else if (fileName.Contains("research"))
                {
                    await LocalStorageService.ImportResearchFromFileAsync(csvContent);
                    researchImported = true;
                }
            }

            // Reload the state from storage
            await CalculationService.LoadStateAsync();
            
            // Refresh rankings to recalculate cascade scores and timers
            RefreshRankings();
            
            // Force state update to ensure UI reflects new data
            StateHasChanged();

            if (generatorsImported && researchImported)
            {
                Snackbar.Add("Both CSV files imported successfully", Severity.Success);
            }
            else if (generatorsImported)
            {
                Snackbar.Add("Generators CSV file imported successfully", Severity.Success);
            }
            else if (researchImported)
            {
                Snackbar.Add("Research CSV file imported successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("No valid CSV files found. Please select generators.csv or research.csv", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error importing files: {ex.Message}", Severity.Error);
        }
    }


    private async Task OpenPrestigeDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PrestigeDialog>("Prestige", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            // Extract multipliers from tuple
            var tuple = result.Data as (double, double)?;
            if (tuple.HasValue)
            {
                var (productionMultiplier, costMultiplier) = tuple.Value;
                await CalculationService.PerformPrestigeAsync(productionMultiplier, costMultiplier);
                RefreshRankings();
                Snackbar.Add($"Prestige completed! Production: {productionMultiplier}x, Cost: {costMultiplier}x", Severity.Success);
            }
        }
    }
}